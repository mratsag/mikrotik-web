{% extends "base.html" %}

{% block title %}VM Kurulum Sonuçları - MikroTik{% endblock %}
{% block page_title %}VM Network Kurulum Sonuçları{% endblock %}
{% block page_subtitle %}{{ results.vm_name }} için network kurulumu tamamlandı{% endblock %}

{% block content %}
<div class="setup-results-container">
    <!-- Kurulum Durumu -->
    <div class="status-card">
        <div class="status-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="status-content">
            <h2>Kurulum Tamamlandı!</h2>
            <p>{{ results.vm_name }} için network altyapısı başarıyla oluşturuldu.</p>
        </div>
    </div>

    <!-- VM Bilgileri -->
    <div class="card">
        <div class="card-title">
            <i class="fas fa-desktop"></i>
            VM Network Bilgileri
        </div>
        
        <div class="vm-info-grid">
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-tag"></i>
                    VM Adı
                </div>
                <div class="info-value">{{ results.vm_name }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-layer-group"></i>
                    VLAN Interface
                </div>
                <div class="info-value">{{ results.vlan_name }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-project-diagram"></i>
                    Bridge Interface
                </div>
                <div class="info-value">{{ results.bridge_name }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-sitemap"></i>
                    Network Adresi
                </div>
                <div class="info-value">{{ results.network_address }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-route"></i>
                    Gateway IP
                </div>
                <div class="info-value">{{ results.gateway_ip }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-server"></i>
                    DHCP Havuzu
                </div>
                <div class="info-value">{{ results.dhcp_range }}</div>
            </div>
        </div>
    </div>

    <!-- Kurulum Adımları ve Sonuçları -->
    <div class="card">
        <div class="card-title">
            <i class="fas fa-list-check"></i>
            Kurulum Adımları
        </div>
        
        <div class="setup-steps">
            {% for result in results.results %}
            <div class="step-item {{ 'success' if result.startswith('✅') else 'error' }}">
                <div class="step-icon">
                    {% if result.startswith('✅') %}
                        <i class="fas fa-check"></i>
                    {% else %}
                        <i class="fas fa-times"></i>
                    {% endif %}
                </div>
                <div class="step-text">{{ result[2:] }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- VM Bağlantı Talimatları -->
    <div class="card">
        <div class="card-title">
            <i class="fas fa-plug"></i>
            VM Bağlantı Talimatları
        </div>
        
        <div class="connection-guide">
            <div class="guide-step">
                <div class="guide-number">1</div>
                <div class="guide-content">
                    <h4>Sanal Makineyi Kapatın</h4>
                    <p>VM'inizi güvenli bir şekilde kapatın (shutdown).</p>
                </div>
            </div>
            
            <div class="guide-step">
                <div class="guide-number">2</div>
                <div class="guide-content">
                    <h4>Network Adapter'ını Değiştirin</h4>
                    <p>VM ayarlarında network adapter'ını <strong>{{ results.vlan_name }}</strong> interface'ine bağlayın.</p>
                    <div class="code-block">
                        <code>Interface: {{ results.vlan_name }}</code>
                    </div>
                </div>
            </div>
            
            <div class="guide-step">
                <div class="guide-number">3</div>
                <div class="guide-content">
                    <h4>VM'i Başlatın</h4>
                    <p>VM'inizi başlatın. Otomatik olarak DHCP'den IP alacaktır.</p>
                    <div class="expected-config">
                        <strong>Beklenen Network Yapılandırması:</strong>
                        <ul>
                            <li>IP Aralığı: {{ results.dhcp_range }}</li>
                            <li>Gateway: {{ results.gateway_ip }}</li>
                            <li>DNS: 8.8.8.8, 8.8.4.4</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="guide-step">
                <div class="guide-number">4</div>
                <div class="guide-content">
                    <h4>Bağlantıyı Test Edin</h4>
                    <p>VM içinde network bağlantısını test edin:</p>
                    <div class="code-block">
                        <code>ping {{ results.gateway_ip }}</code><br>
                        <code>ping 8.8.8.8</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Port Forwarding Önerileri -->
    <div class="card">
        <div class="card-title">
            <i class="fas fa-arrow-right"></i>
            Port Forwarding Önerileri
        </div>
        
        <div class="port-suggestions">
            <div class="suggestion-item">
                <div class="service-icon">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="service-info">
                    <h5>Web Server (HTTP)</h5>
                    <p>Dış Port: 8080 → VM Port: 80</p>
                    <button class="btn btn-sm btn-primary" onclick="createPortForward(8080, 80, 'tcp', '{{ results.vm_name }}-HTTP')">
                        Port Forward Ekle
                    </button>
                </div>
            </div>
            
            <div class="suggestion-item">
                <div class="service-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <div class="service-info">
                    <h5>Web Server (HTTPS)</h5>
                    <p>Dış Port: 8443 → VM Port: 443</p>
                    <button class="btn btn-sm btn-primary" onclick="createPortForward(8443, 443, 'tcp', '{{ results.vm_name }}-HTTPS')">
                        Port Forward Ekle
                    </button>
                </div>
            </div>
            
            <div class="suggestion-item">
                <div class="service-icon">
                    <i class="fas fa-terminal"></i>
                </div>
                <div class="service-info">
                    <h5>SSH Erişimi</h5>
                    <p>Dış Port: 2222 → VM Port: 22</p>
                    <button class="btn btn-sm btn-primary" onclick="createPortForward(2222, 22, 'tcp', '{{ results.vm_name }}-SSH')">
                        Port Forward Ekle
                    </button>
                </div>
            </div>
            
            <div class="suggestion-item">
                <div class="service-icon">
                    <i class="fas fa-desktop"></i>
                </div>
                <div class="service-info">
                    <h5>Remote Desktop (RDP)</h5>
                    <p>Dış Port: 3389 → VM Port: 3389</p>
                    <button class="btn btn-sm btn-primary" onclick="createPortForward(3389, 3389, 'tcp', '{{ results.vm_name }}-RDP')">
                        Port Forward Ekle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Monitoring -->
    <div class="card">
        <div class="card-title">
            <i class="fas fa-chart-line"></i>
            Network Monitoring
        </div>
        
        <div class="monitoring-actions">
            <a href="{{ url_for('ip_monitor') }}" class="btn btn-info">
                <i class="fas fa-eye"></i>
                IP Monitoring'e Git
            </a>
            
            <a href="{{ url_for('dhcp_management') }}" class="btn btn-info">
                <i class="fas fa-server"></i>
                DHCP Yönetimi
            </a>
            
            <a href="{{ url_for('interface_management') }}" class="btn btn-info">
                <i class="fas fa-network-wired"></i>
                Interface Yönetimi
            </a>
            
            <button class="btn btn-success" onclick="testVMConnection()">
                <i class="fas fa-wifi"></i>
                VM Bağlantısını Test Et
            </button>
        </div>
    </div>

    <!-- Sonraki Adımlar -->
    <div class="card">
        <div class="card-title">
            <i class="fas fa-forward"></i>
            Sonraki Adımlar
        </div>
        
        <div class="next-steps">
            <div class="next-step-item">
                <div class="step-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <div class="step-content">
                    <h5>Yeni VM Ekle</h5>
                    <p>Aynı network'e başka VM'ler ekleyebilirsiniz.</p>
                    <a href="{{ url_for('vm_network_wizard') }}" class="btn btn-sm btn-primary">
                        Yeni VM Sihirbazı
                    </a>
                </div>
            </div>
            
            <div class="next-step-item">
                <div class="step-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="step-content">
                    <h5>Güvenlik Ayarları</h5>
                    <p>Firewall kuralları ve güvenlik politikaları ekleyin.</p>
                    <a href="{{ url_for('advanced_nat') }}" class="btn btn-sm btn-warning">
                        Güvenlik Ayarları
                    </a>
                </div>
            </div>
            
            <div class="next-step-item">
                <div class="step-icon">
                    <i class="fas fa-backup"></i>
                </div>
                <div class="step-content">
                    <h5>Yapılandırma Yedeği</h5>
                    <p>MikroTik yapılandırmasının yedeğini alın.</p>
                    <button class="btn btn-sm btn-secondary" onclick="alert('MikroTik WebUI -> Files -> Backup')">
                        Yedek Al
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hızlı Erişim -->
    <div class="quick-access">
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="fas fa-home"></i> Ana Sayfa
        </a>
        <a href="{{ url_for('vm_network_wizard') }}" class="btn btn-success">
            <i class="fas fa-plus"></i> Yeni VM Network
        </a>
        <a href="{{ url_for('ip_monitor') }}" class="btn btn-info">
            <i class="fas fa-monitor"></i> IP Monitoring
        </a>
    </div>
</div>

<style>
.setup-results-container {
    max-width: 1000px;
    margin: 0 auto;
}

.status-card {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 15px 35px rgba(40, 167, 69, 0.3);
}

.status-icon {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.9;
}

.status-content h2 {
    font-size: 2.5rem;
    margin-bottom: 15px;
    font-weight: 700;
}

.status-content p {
    font-size: 1.2rem;
    opacity: 0.9;
}

.vm-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.info-item {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #667eea;
}

.info-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #666;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.info-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #333;
    font-family: 'Consolas', monospace;
}

.setup-steps {
    space-y: 15px;
}

.step-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.step-item.success {
    background: #d4edda;
    border-left: 4px solid #28a745;
}

.step-item.error {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
}

.step-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.step-item.success .step-icon {
    background: #28a745;
    color: white;
}

.step-item.error .step-icon {
    background: #dc3545;
    color: white;
}

.step-text {
    flex: 1;
    font-weight: 500;
    color: #333;
}

.connection-guide {
    space-y: 25px;
}

.guide-step {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
}

.guide-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.guide-content {
    flex: 1;
}

.guide-content h4 {
    color: #333;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.guide-content p {
    color: #666;
    margin-bottom: 15px;
    line-height: 1.6;
}

.code-block {
    background: #2d3748;
    color: #e2e8f0;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Consolas', monospace;
    margin-bottom: 15px;
}

.expected-config {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #2196f3;
}

.expected-config ul {
    margin: 10px 0 0 20px;
    color: #333;
}

.port-suggestions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.suggestion-item {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
}

.suggestion-item:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.service-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.service-info h5 {
    color: #333;
    margin-bottom: 5px;
    font-size: 1rem;
}

.service-info p {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 10px;
    font-family: monospace;
}

.monitoring-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.next-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.next-step-item {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 15px;
    display: flex;
    gap: 15px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.next-step-item:hover {
    border-color: #667eea;
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
}

.next-step-item .step-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.next-step-item .step-content h5 {
    color: #333;
    margin-bottom: 10px;
    font-size: 1.1rem;
}

.next-step-item .step-content p {
    color: #666;
    margin-bottom: 15px;
    font-size: 0.9rem;
    line-height: 1.5;
}

.quick-access {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 40px;
    padding: 30px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

@media (max-width: 768px) {
    .vm-info-grid,
    .port-suggestions,
    .next-steps {
        grid-template-columns: 1fr;
    }
    
    .guide-step {
        flex-direction: column;
        text-align: center;
    }
    
    .monitoring-actions,
    .quick-access {
        flex-direction: column;
    }
    
    .suggestion-item,
    .next-step-item {
        flex-direction: column;
        text-align: center;
    }
}

/* Success animation */
@keyframes success-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.status-card {
    animation: success-pulse 2s ease-in-out;
}

/* Fade in animation */
.card {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
// Port forwarding ekleme fonksiyonu
function createPortForward(externalPort, internalPort, protocol, name) {
    const confirmed = confirm(`${name} için port forwarding oluşturulsun mu?\n\nDış Port: ${externalPort}\nİç Port: ${internalPort}\nProtokol: ${protocol.toUpperCase()}`);
    
    if (confirmed) {
        // NAT rule ekleme formu oluştur ve gönder
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/add_rule';
        form.style.display = 'none';
        
        const fields = {
            'name': name,
            'external_port': externalPort,
            'internal_ip': '{{ results.dhcp_range.split("-")[0].strip() }}', // İlk DHCP IP'sini al
            'internal_port': internalPort
        };
        
        Object.keys(fields).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = fields[key];
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

// VM bağlantı testi
function testVMConnection() {
    const vmNetwork = '{{ results.network_address }}';
    const gateway = '{{ results.gateway_ip }}';
    
    // Basit ping testi (gerçek implementasyon için backend gerekli)
    alert(`VM Bağlantı Testi Başlatıldı!\n\nTest edilen:\n• Gateway: ${gateway}\n• Network: ${vmNetwork}\n\nSonuçlar IP Monitoring sayfasında görülebilir.`);
    
    // IP Monitoring sayfasına yönlendir
    setTimeout(() => {
        window.open('/ip_monitor', '_blank');
    }, 2000);
}

// Sayfa yüklendiğinde başarı mesajı göster
document.addEventListener('DOMContentLoaded', function() {
    // Success sound (eğer tarayıcı destekliyorsa)
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEaBC2Jzffai0MLFmm98+GTNQEW');
        audio.volume = 0.3;
        audio.play().catch(() => {}); // Ignore errors
    } catch (e) {}
    
    // Auto scroll to status card
    document.querySelector('.status-card').scrollIntoView({
        behavior: 'smooth',
        block: 'center'
    });
    
    // Show completion message after 3 seconds
    setTimeout(() => {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
            z-index: 1000;
            font-weight: 600;
        `;
        toast.innerHTML = '<i class="fas fa-check"></i> VM Network başarıyla kuruldu!';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }, 3000);
});
</script>
{% endblock %}